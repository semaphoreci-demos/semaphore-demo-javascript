# This pipeline runs after semaphore.yml
version: v1.0
name: Client deploy
agent:
  machine:
    # Use a machine type with more RAM and CPU power for faster container
    # builds:
    type: e1-standard-4
    os_image: ubuntu1804
blocks:
  - name: Build
    task:
      # Mount a secret which defines /home/semaphore/.kube/gc-k8s.yaml.
      # By mounting it, we make file available in the job environment.
      # For info on creating secrets, see:
      # https://docs.semaphoreci.com/article/66-environment-variables-and-secrets
      secrets:
        - name: gc-k8s-secret
        - name: gcr-secret
      jobs:
        - name: Deploy to Google Cloud Storage
          commands:
            # Authenticate using the file injected from the secret
            - gcloud auth activate-service-account --key-file=.secrets.gcp.json
            # Don't forget -q to silence confirmation prompts
            - gcloud auth configure-docker -q
            - gcloud config set project $GCP_PROJECT_ID
            - gcloud config set compute/zone $GCP_PROJECT_DEFAULT_ZONE

            # Get the latest version of our source code from GitHub:
            - checkout --use-cache
            - cd src/client

            # Restore dependencies from cache.
            # For more info on caching, see https://docs.semaphoreci.com/article/68-caching-dependencies
            - cache restore client-node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),client-node-modules-$SEMAPHORE_GIT_BRANCH,client-node-modules-master

            # Restore build from cache.
            - cache restore client-build-$SEMAPHORE_WORKFLOW_ID

            # Deploy to Google Cloud Storage
            - gsutil -m rsync -r build gs://$BUCKET_NAME
            - gsutil iam ch allUsers:objectViewer gs://$BUCKET_NAME
            - gsutil web set -m index.html -e 404.html gs://$BUCKET_NAME
